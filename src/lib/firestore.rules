rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is the owner of a specific shop
    function isShopOwner(shopId) {
      return request.auth.uid == shopId;
    }

    // Rules for the shops collection
    match /shops/{shopId} {
      // Owner can do anything to their own shop document.
      // A new user can create their own shop document.
      allow create: if isShopOwner(shopId);
      allow read, update, delete: if isShopOwner(shopId);
      
      // Public read for the shop details page that customers see
      allow get;

      // --- SUBCOLLECTIONS ---
      
      // Offers subcollection
      match /offers/{offerId} {
        // Shop owner can manage their own offers
        allow read, write, delete: if isShopOwner(shopId);
        
        // Any user (including unauthenticated) can list offers for a shop
        allow list;
      }
      
      // Claims subcollection
      match /claims/{claimId} {
        // Shop owner can read/update claims (e.g., to mark as redeemed)
        allow read, update: if isShopOwner(shopId);
        
        // Anyone can create a claim (since it's an unauthenticated action)
        allow create;
      }
    }
  }
}

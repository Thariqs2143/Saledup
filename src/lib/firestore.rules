
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is the owner of a specific shop
    function isShopOwner(shopId) {
      // The user is the owner if their UID matches the shop document's ID
      return request.auth != null && request.auth.uid == shopId;
    }

    // Rules for the shops collection
    match /shops/{shopId} {
      // A new user can create their own shop document, as long as the ownerId in the
      // document they are creating matches their own UID.
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      
      // The shop owner can update or delete their own shop document.
      allow update, delete: if isShopOwner(shopId);
      
      // Any user (including unauthenticated) can read the main shop details.
      // This is needed for the public-facing shop pages.
      allow get;
      allow list: if true; // Allow listing all shops for the find-offers page


      // --- SUBCOLLECTIONS ---
      
      // Offers subcollection
      match /offers/{offerId} {
        // Shop owner can manage their offers (create, update, delete).
        allow create, update, delete: if isShopOwner(shopId);

        // A shop owner needs to be able to list their own offers for the admin dashboard.
        allow list: if isShopOwner(shopId);
        
        // Allow public read for a single offer.
        allow get: if true;
      }
      
      // Claims subcollection
      match /claims/{claimId} {
        // Shop owner can read/update/delete individual claims and list all of them.
        allow read, list, update, delete: if isShopOwner(shopId);
        
        // Anyone can create a claim (since it's an unauthenticated action).
        allow create: if true;
      }
    }

     // Allow unauthenticated users to list offers across all shops for the public "Find Offers" page.
    match /{path=**}/offers/{offerId} {
      allow list: if true;
    }
  }
}

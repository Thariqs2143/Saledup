rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is the owner of a specific shop
    function isShopOwner(shopId) {
      // The user is the owner if their UID matches the shop document's ID
      return request.auth != null && request.auth.uid == shopId;
    }

    // Rules for the shops collection
    match /shops/{shopId} {
      // A new user can create their own shop document, as long as the ownerId in the
      // document they are creating matches their own UID.
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      
      // The shop owner can update or delete their own shop document.
      allow update, delete: if isShopOwner(shopId);
      
      // Any user (including unauthenticated) can read the main shop details.
      // This is needed for the public-facing shop pages.
      allow get;
      allow list: if request.auth != null;


      // --- SUBCOLLECTIONS ---
      
      // Offers subcollection
      match /offers/{offerId} {
        // Shop owner can manage their own offers
        allow read, write, delete: if isShopOwner(shopId);
        
        // Any user (including unauthenticated) can list offers for a shop
        allow list;
      }
      
      // Claims subcollection
      match /claims/{claimId} {
        // Shop owner can read/update claims (e.g., to mark as redeemed)
        allow read, update: if isShopOwner(shopId);
        
        // Anyone can create a claim (since it's an unauthenticated action)
        allow create;
      }
    }
  }
}

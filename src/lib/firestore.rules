rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is the owner of a specific shop
    function isShopOwner(shopId) {
      // The user is the owner if their UID matches the shop document's ID
      return request.auth != null && request.auth.uid == shopId;
    }

    // Rules for the shops collection
    match /shops/{shopId} {
      // A new user can create their own shop document, as long as the ownerId in the
      // document they are creating matches their own UID.
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      
      // The shop owner can update or delete their own shop document.
      allow update, delete: if isShopOwner(shopId);
      
      // Any user (including unauthenticated) can read the main shop details.
      // This is needed for the public-facing shop pages.
      allow get;
      allow list: if request.auth != null;


      // --- SUBCOLLECTIONS ---
      
      // Offers subcollection
      match /offers/{offerId} {
        // Shop owner can manage their offers (read, write, delete).
        // Any user can list offers for a public shop page.
        allow read, write, delete: if isShopOwner(shopId);
        allow list: if isShopOwner(shopId) || true;
      }
      
      // Claims subcollection
      match /claims/{claimId} {
        // Shop owner can read/update individual claims and list all of them.
        allow get, list, update: if isShopOwner(shopId);
        
        // Anyone can create a claim (since it's an unauthenticated action).
        allow create;
      }
    }
  }
}


rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------
    // Helper Functions
    // ----------------------
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Checks if the requesting user is the owner of the shop document being accessed.
    function isShopOwner(shopId) {
      return request.auth != null && request.auth.uid == shopId;
    }

    // Checks if the requesting user is an employee of a given shop.
    function isEmployee(shopId) {
        return request.auth != null && exists(/databases/$(database)/documents/shops/$(shopId)/employees/$(request.auth.uid));
    }
    
    // Checks if the requesting user is the owner OR an employee of a given shop.
    function isOwnerOrEmployee(shopId) {
      return isShopOwner(shopId) || isEmployee(shopId);
    }
    
    // Get the role of the current authenticated user for a specific shop.
    function getRole(shopId) {
        let employeeDoc = /databases/$(database)/documents/shops/$(shopId)/employees/$(request.auth.uid);
        if (exists(employeeDoc)) {
            return get(employeeDoc).data.role;
        }
        return 'none';
    }

    // ----------------------
    // Global Collections
    // ----------------------
    
    // This collection is used for employees to quickly find which shop they belong to upon login.
    match /employee_phone_to_shop_lookup/{phone} {
      // Anyone can read this to find their shop during login.
      allow read: if true;
      // Only a shop owner can create a lookup entry for their employees.
      allow create: if isShopOwner(request.resource.data.shopId);
      // Only shop owner can delete lookup entry when deleting an employee
      allow delete: if isShopOwner(resource.data.shopId);
      // No updates allowed to prevent tampering.
      allow update: if false;
    }
    
    // This collection stores universal customer profiles for the rewards system.
    match /customers/{phone} {
        // Authenticated users (shop owners/employees) can read customer data when redeeming points.
        allow get: if isSignedIn();
        // Claims process (unauthenticated) writes to this collection. Security rules on the claim endpoint handle this.
        // For direct writes, only allow creation if it doesn't exist, and updates if it does.
        allow write: if true;
    }

    // This collection stores all gift vouchers, accessible via their unique ID.
    match /vouchers/{voucherId} {
      // A user can read a specific voucher if they are the owner of the associated shop OR it's a public verification.
      allow get: if true;
      // A user can list vouchers only if the query is filtering for their own shopId.
      allow list: if isSignedIn() && request.query.get('shopId') == request.auth.uid;
      // Shop owners can create vouchers for their shop.
      allow create: if isShopOwner(request.resource.data.shopId);
      // Only staff of the specific shop can update a voucher (to redeem it).
      allow update: if isOwnerOrEmployee(resource.data.shopId);
      // Only the shop owner can delete a voucher.
      allow delete: if isShopOwner(resource.data.shopId);
    }


    // ----------------------
    // Shop-specific data
    // ----------------------
    match /shops/{shopId} {
      allow create: if isShopOwner(shopId); // A user can create their own shop document
      allow update, delete: if isShopOwner(shopId); // Only owner can manage the main shop doc.
      // Public can read shop details for shop pages and find-offers page
      allow read: if true; 

      // --- Subcollections ---
      
      // Employees Subcollection
      match /employees/{employeeId} {
        // Shop owner can manage their staff.
        allow create, update, delete: if isShopOwner(shopId);
        // All staff and the owner can read employee details.
        allow read, list: if isOwnerOrEmployee(shopId);
      }
      
      // Offers Subcollection
      match /offers/{offerId} {
        // Owner and Managers can create and delete offers.
        allow create, delete: if isShopOwner(shopId) || getRole(shopId) == 'Manager';
        // Allow public views to increment viewCount, and owners/managers to edit anything.
        allow update: if (isShopOwner(shopId) || getRole(shopId) == 'Manager') || 
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount']));
        // All staff can list offers.
        allow list: if isOwnerOrEmployee(shopId);
        // Public can view offers.
        allow get: if true;
      }
      
      // Claims Subcollection
      match /claims/{claimId} {
        // Owner and staff can read/list claims for verification.
        // Cashiers need this to redeem.
        allow read, list: if isOwnerOrEmployee(shopId);
        // Owner and staff can update a claim's status (e.g., to 'redeemed').
        allow update: if isOwnerOrEmployee(shopId);
        // Only owner can delete claim history.
        allow delete: if isShopOwner(shopId);
        // Public can create claims.
        allow create: if true;
      }
      
      // Point Redemption Logs Subcollection
      match /points_redemptions/{logId} {
          // Only owner and employees can create redemption logs.
          allow create: if isOwnerOrEmployee(shopId);
          // Only owner can read logs for auditing.
          allow read, list: if isShopOwner(shopId);
      }
      
      // Reviews Subcollection
      match /reviews/{reviewId} {
        // Anyone can create a review
        allow create: if true;
        // Anyone can read reviews
        allow read, list: if true;
        // Only the shop owner can delete reviews
        allow delete: if isShopOwner(shopId);
        // No updates allowed
        allow update: if false;
      }

      // Config Subcollection
      match /config/{docId} {
        allow read, write: if isShopOwner(shopId);
      }
    }
    
    // --- Collection Group Queries ---
    
    // Allow unauthenticated users to list offers across all shops for the public "Find Offers" page.
    match /{path=**}/offers/{offerId} {
      allow list: if true;
    }
  }
}
